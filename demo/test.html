<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lua WASM Test Suite</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Monaco', monospace;
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { 
      color: #4ec9b0;
      margin-bottom: 20px;
    }
    .test-result {
      background: #252526;
      padding: 12px;
      margin: 8px 0;
      border-radius: 3px;
      border-left: 3px solid #666;
    }
    .pass {
      color: #6fc96f;
      border-left-color: #6fc96f;
    }
    .fail {
      color: #f97777;
      border-left-color: #f97777;
    }
    .summary {
      background: #252526;
      padding: 15px;
      margin: 20px 0;
      border-radius: 3px;
      border-left: 3px solid #4ec9b0;
    }
    .summary-value {
      font-size: 18px;
      font-weight: bold;
      color: #4ec9b0;
      margin-top: 5px;
    }
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #4ec9b0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Lua WASM Test Suite</h1>
    <div id="results"></div>
    <div id="summary" style="display: none;" class="summary">
      <div>Test Results</div>
      <div class="summary-value" id="summary-text"></div>
    </div>
  </div>

  <script type="module">
    import lua from './lua-api.js';

    const resultsDiv = document.getElementById('results');
    const summaryDiv = document.getElementById('summary');
    const summaryText = document.getElementById('summary-text');

    function addResult(name, passed, message = '') {
      const div = document.createElement('div');
      div.className = `test-result ${passed ? 'pass' : 'fail'}`;
      const icon = passed ? '‚úÖ' : '‚ùå';
      div.textContent = `${icon} Test ${name}: ${message}`;
      resultsDiv.appendChild(div);
    }

    async function runTests() {
      resultsDiv.innerHTML = '<div class="test-result"><div class="loader"></div> Running tests...</div>';
      
      const tests = [];
      let passed = 0;
      let failed = 0;

      try {
        await lua.loadLuaWasm();
        addResult('1 - Module Load', true, 'WASM module loaded successfully');
        passed++;
      } catch (e) {
        addResult('1 - Module Load', false, e.message);
        failed++;
        displaySummary(passed, failed);
        return;
      }

      try {
        const code = lua.init();
        addResult('2 - init()', true, `returned ${code}`);
        passed++;
      } catch (e) {
        addResult('2 - init()', false, e.message);
        failed++;
      }

      try {
        const ptr = lua.getBufferPtr();
        if (typeof ptr === 'number' && ptr >= 0) {
          addResult('3 - getBufferPtr()', true, `pointer = ${ptr}`);
          passed++;
        } else {
          throw new Error('Invalid pointer: ' + ptr);
        }
      } catch (e) {
        addResult('3 - getBufferPtr()', false, e.message);
        failed++;
      }

      try {
        const size = lua.getBufferSize();
        if (size === 65536) {
          addResult('4 - getBufferSize()', true, `size = ${size} bytes`);
          passed++;
        } else {
          throw new Error(`Invalid size: ${size} (expected 65536)`);
        }
      } catch (e) {
        addResult('4 - getBufferSize()', false, e.message);
        failed++;
      }

      try {
        const result = lua.compute('return 1 + 1');
        if (typeof result === 'number') {
          addResult('5 - compute()', true, `returned ${result} bytes`);
          passed++;
        } else {
          throw new Error('Invalid result type: ' + typeof result);
        }
      } catch (e) {
        addResult('5 - compute()', false, e.message);
        failed++;
      }

      try {
        const stats = lua.getMemoryStats();
        if (stats && typeof stats.total === 'number' && stats.total > 0) {
          addResult('6 - getMemoryStats()', true, `${(stats.total / 1024 / 1024).toFixed(2)} MB total`);
          passed++;
        } else {
          throw new Error('Invalid memory stats');
        }
      } catch (e) {
        addResult('6 - getMemoryStats()', false, e.message);
        failed++;
      }

      try {
        lua.runGc();
        addResult('7 - runGc()', true, 'garbage collection completed');
        passed++;
      } catch (e) {
        addResult('7 - runGc()', false, e.message);
        failed++;
      }

      try {
        const bufPtr = lua.getBufferPtr();
        const data = 'Hello WASM!';
        lua.writeBuffer(bufPtr, data);
        const read = lua.readBuffer(bufPtr, data.length);
        if (read === data) {
          addResult('8 - readBuffer/writeBuffer', true, `data verified "${read}"`);
          passed++;
        } else {
          throw new Error(`Mismatch: "${read}" !== "${data}"`);
        }
      } catch (e) {
        addResult('8 - readBuffer/writeBuffer', false, e.message);
        failed++;
      }

      displaySummary(passed, failed);
    }

    function displaySummary(passed, failed) {
      const total = passed + failed;
      summaryDiv.style.display = 'block';
      summaryText.textContent = `${passed}/${total} passing`;
      
      if (failed === 0) {
        summaryDiv.style.borderLeftColor = '#6fc96f';
        summaryText.style.color = '#6fc96f';
      } else {
        summaryDiv.style.borderLeftColor = '#f97777';
        summaryText.style.color = '#f97777';
      }
    }

    runTests();
  </script>
</body>
</html>
